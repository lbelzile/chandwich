<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Loglikelihood adjustment using the sandwich estimator — adjust_loglik • chandwich</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Loglikelihood adjustment using the sandwich estimator — adjust_loglik" />
<meta property="og:description" content="Performs adjustments of a user-supplied independence loglikelihood for the
presence of cluster dependence, following
Chandler and Bate (2007).
The user provides a function that returns a vector of observation-specific
loglikelihood contributions and a vector that indicates cluster membership.
The loglikelihood of a sub-model can be adjusted by fixing a set of
parameters at particular values." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">chandwich</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/chandwich-vignette.html">Introducing chandwich: Chandler-Bate Loglikelihood Adjustment</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/paulnorthrop/chandwich/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Loglikelihood adjustment using the sandwich estimator</h1>
    <small class="dont-index">Source: <a href='https://github.com/paulnorthrop/chandwich/blob/master/R/adjust_loglik.R'><code>R/adjust_loglik.R</code></a></small>
    <div class="hidden name"><code>adjust_loglik.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Performs adjustments of a user-supplied independence loglikelihood for the
presence of cluster dependence, following
<a href='http://dx.doi.org/10.1093/biomet/asm015'>Chandler and Bate (2007)</a>.
The user provides a function that returns a vector of observation-specific
loglikelihood contributions and a vector that indicates cluster membership.
The loglikelihood of a sub-model can be adjusted by fixing a set of
parameters at particular values.</p>
    </div>

    <pre class="usage"><span class='fu'>adjust_loglik</span>(
  <span class='kw'>loglik</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='no'>...</span>,
  <span class='kw'>cluster</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>p</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>init</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>fixed_at</span> <span class='kw'>=</span> <span class='fl'>0</span>,
  <span class='kw'>name</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>larger</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>alg_deriv</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>alg_hess</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>mle</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>H</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>V</span> <span class='kw'>=</span> <span class='kw'>NULL</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>loglik</th>
      <td><p>A named function.  Returns a vector of the
loglikelihood contributions of individual observations.  The first
argument must be the vector of model parameter(s). If any of the model
parameters are out-of-bounds then <code>loglik</code> should return either
<code>-Inf</code> or a vector with at least one element equal to <code>-Inf</code>.
The number of parameters in the <strong>full</strong> model must be specified
using (at least) one of the arguments <code>p</code>, <code>init</code> or
<code>par_names</code>.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Further arguments to be passed either to <code>loglik</code>
(and to <code>alg_deriv</code> and <code>alg_hess</code> if these are supplied) or
to <code><a href='https://rdrr.io/r/stats/optim.html'>optim</a></code>.  The latter may include <code>gr</code>,
<code>method</code>, <code>lower</code>, <code>upper</code> or <code>control</code>.
In the call to <code><a href='https://rdrr.io/r/stats/optim.html'>optim</a></code>, <code>hessian = TRUE</code>
will be used regardless of any value supplied.
The function <code>loglik</code> must <em>not</em> have arguments with names
that match any of these arguments to <code><a href='https://rdrr.io/r/stats/optim.html'>optim</a></code>.</p></td>
    </tr>
    <tr>
      <th>cluster</th>
      <td><p>A vector or factor indicating from which cluster the
respective loglikelihood contributions from <code>loglik</code> originate.
Must have the same length as the vector returned by <code>loglik</code>.
If <code>cluster</code> is not supplied then it is set inside
<code>adjust_loglik</code> under the assumption that each observation forms
its own cluster.</p></td>
    </tr>
    <tr>
      <th>p</th>
      <td><p>A numeric scalar.  The dimension of the <strong>full</strong> parameter
vector, i.e. the number of parameters in the full model.  Must be
consistent with the lengths of <code>init</code> and <code>par_names</code>,
if these are also supplied.</p></td>
    </tr>
    <tr>
      <th>init</th>
      <td><p>A numeric vector of initial values.  Must have length equal
to the number of parameters in the <strong>full</strong> model.  If <code>init</code>
is supplied then <code>p</code> is set to <code><a href='https://rdrr.io/r/base/length.html'>length(init)</a></code>, provided that
this is consistent with the the value given by <code>p</code> or implied
by <code><a href='https://rdrr.io/r/base/length.html'>length(par_names)</a></code>.
If <code>fixed_pars</code> is not <code>NULL</code> then <code>init[-fixed_pars]</code>
is used in the search for the MLE.
If <code>init</code> is not supplied then <code><a href='https://rdrr.io/r/base/rep.html'>rep(0.1, p)</a></code> is used.</p></td>
    </tr>
    <tr>
      <th>par_names</th>
      <td><p>A character vector.  Names of the <code>p</code> parameters
in the <strong>full</strong> model.  Must be consistent with the lengths of
<code>init</code> and <code>p</code>, if these are also supplied.</p></td>
    </tr>
    <tr>
      <th>fixed_pars</th>
      <td><p>A vector specifying which parameters are to be restricted
to be equal to the value(s) in <code>fixed_at</code>.  Can be either a numeric
vector, specifying indices of the components of the <strong>full</strong> parameter
vector, or a character vector of parameter names, which must be a subset
of those supplied in <code>par_names</code> or stored in the object
<code>larger</code>.</p></td>
    </tr>
    <tr>
      <th>fixed_at</th>
      <td><p>A numeric vector of length 1 or <code><a href='https://rdrr.io/r/base/length.html'>length(fixed_pars)</a></code>.
If <code>length(fixed_at) = 1</code> then the components <code>fixed_pars</code>
of the parameter vector are all fixed at <code>fixed_at</code>.
If <code>length(fixed_at) = length(fixed_pars)</code> then the component
<code>fixed_pars[i]</code> is fixed at <code>fixed_at[i]</code> for each <code>i</code>.</p></td>
    </tr>
    <tr>
      <th>name</th>
      <td><p>A character scalar.  A name for the model that gives rise
to <code>loglik</code>.  If this is not supplied then the name in
<code>larger</code> is used, if this has been supplied, and the name of
the function <code>loglik</code> otherwise.</p></td>
    </tr>
    <tr>
      <th>larger</th>
      <td><p>Only relevant if <code>fixed_pars</code> is not <code>NULL</code>.
  If <code>larger</code> is supplied but <code>fixed_pars</code> is not then an error
  will result.  if <code>larger</code> is supplied then information about the
  model in <code>larger</code>, e.g. about <code>p</code> and <code>par_names</code> will
  override any attempt to set these arguments in the call to
  <code>adjust_loglik</code>.</p>
<p>An object of class <code>"chandwich"</code> returned by <code>adjust_loglik</code>,
  corresponding to a model in which the smaller model implied by
  <code>fixed_pars</code> is nested.  If <code>larger</code> is supplied then
  all the arguments to <code>adjust_loglik</code> apart from
  <code>fixed_pars</code> and <code>fixed_at</code> are extracted from <code>larger</code>.
  If <code>init</code> is not supplied in the current call to
  <code>adjust_loglik</code> then <code>init</code> is set to
  <code><a href='https://rdrr.io/r/base/attr.html'>attr(larger, "MLE")</a></code>, with the elements in <code>fixed_pars</code>
  set to <code>fixed_at</code>.</p></td>
    </tr>
    <tr>
      <th>alg_deriv</th>
      <td><p>A function with the vector of model parameter(s) as its
first argument.  Returns a <code><a href='https://rdrr.io/r/base/length.html'>length(cluster)</a></code> by <code>p</code> numeric
matrix. Column i contains the derivatives of each of the loglikelihood
contributions in <code>loglik</code> with respect to model parameter i.</p></td>
    </tr>
    <tr>
      <th>alg_hess</th>
      <td><p>A function with the vector of model parameter(s) as its
  first argument.  Returns a <code>p</code> by <code>p</code> numeric matrix equal to
  the Hessian of <code>loglik</code>, i.e. the matrix of second derivatives of
  the function <code>loglik</code>.</p>
<p>Supplying both <code>V</code> and <code>alg_deriv</code> or both <code>H</code> and
  <code>alg_hess</code> will produce an error.</p></td>
    </tr>
    <tr>
      <th>mle</th>
      <td><p>A numeric vector.  Can only be used if <code>fixed_pars = NULL</code>.
Provides the maximum likelihood estimate of the model parameters,
that is, the value of the parameter vector
at which the independence loglikelihood <code>loglik</code> is maximized.
Must have length equal to the number of parameters in the
<strong>full</strong> model.  If <code>mle</code> is supplied then <code>p</code> is set
to <code><a href='https://rdrr.io/r/base/length.html'>length(mle)</a></code>, provided that this is consistent with the the
value given by <code>p</code> or implied by <code><a href='https://rdrr.io/r/base/length.html'>length(par_names)</a></code>.
If <code>mle</code> is supplied then it overrides <code>init</code>.</p></td>
    </tr>
    <tr>
      <th>H, V</th>
      <td><p>p by p numeric matrices.  Only used if <code>mle</code> is supplied.
  Provide estimates of the Hessian of the
  independence loglikelihood (H) and the variance of the vector
  of cluster-specific contributions to the score vector (first
  derivatives with respect to the parameters) of the independence
  loglikelihood, each evaluated at the MLE <code>mle</code>.  See the
  <em>Introducing chandwich</em> vignette and/or Chandler and Bate (2007).</p>
<p>Supplying both <code>V</code> and <code>alg_deriv</code> or both <code>H</code> and
  <code>alg_hess</code> will produce an error.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A function of class <code>"chandwich"</code> to evaluate an adjusted
  loglikelihood, or the independence loglikelihood, at one or more sets
  of model parameters, with arguments</p>
<dt>x</dt><dd><p>A numeric vector or matrix giving values of the <code>p_current</code>
    (see below) parameters in the model to which the returned adjusted
    loglikelihood applies.
    If <code>p_current = 1</code> this may be a numeric vector or a matrix
    with 1 column.
    If <code>p_current &gt; 1</code> this may be a numeric vector of length <code>p</code>
    (one set of model parameters) or a numeric matrix with <code>p</code>
    columns (<code><a href='https://rdrr.io/r/base/nrow.html'>nrow(x)</a></code> sets of model parameters), one set in each row
    of <code>x</code>.</p></dd>
  <dt>type</dt><dd><p>A character scalar.  The type of adjustment to use.
    One of <code>"vertical"</code>, <code>"cholesky"</code>, <code>"spectral"</code> or
    <code>"none"</code>.</p></dd>  The latter results in the evaluation of the
    (unadjusted) independence loglikelihood.
  The function has (additional) attributes
  <dt>p_full, p_current</dt><dd><p>The number of parameters in the full model and
    current models, respectively.</p></dd>
  <dt>free_pars</dt><dd><p>A numeric vector giving the indices of the free
    parameters in the current model, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>
  <dt>MLE, res_MLE</dt><dd><p>Numeric vectors, with names inferred from
    <code>par_names</code> if this was supplied.  Maximum likelihood estimates
    of free parameters under the current model (<code>mle</code>) and all
    parameters in the full model, including any parameters with fixed
    values (<code>res_MLE</code>).</p></dd>
  <dt>SE, adjSE</dt><dd><p>The unadjusted and adjusted estimated standard errors,
    of the free parameters, respectively.</p></dd>
  <dt>VC, adjVC</dt><dd><p>The unadjusted and adjusted estimated
    variance-covariance matrix of the free parameters, respectively.</p></dd>
  <dt>HI, HA</dt><dd><p>The Hessians of the independence and adjusted loglikelihood,
    respectively.</p></dd>
  <dt>C_cholesky, C_spectral</dt><dd><p>The matrix C in equation (14) of Chandler and
    Bate (2007), calculated using Cholesky decomposition and spectral
    decomposition, respectively.</p></dd>
  <dt>full_par_names, par_names</dt><dd><p>The names of the parameters in the full
    and current models, respectively, if these were supplied in
    this call or a previous call.</p></dd>
  <dt>max_loglik</dt><dd><p>The common maximised value of the independence and
    adjusted loglikelihoods.</p></dd>
  <dt>loglik, cluster</dt><dd><p>The arguments <code>loglik</code> and <code>cluster</code>
    supplied in this call, or a previous call.</p></dd>
  <dt>loglik_args</dt><dd><p>A list containing the further arguments passed to
    <code>loglik</code> via ... in this call, or a previous call.</p></dd>
  <dt>name</dt><dd><p>The argument <code>name</code>, or the name of the function
    <code>loglik</code> if <code>name</code> isn't supplied.</p></dd>
  <dt>nobs</dt><dd><p>The number of observations.</p></dd>
  <dt>call</dt><dd><p>The call to <code>adjust_loglik</code>.</p></dd>
  If fixed_pars is not NULL then there are further attributes
  <dt>fixed_pars</dt><dd><p>The argument <code>fixed_pars</code>, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>
  <dt>fixed_at</dt><dd><p>The argument <code>fixed_at</code>, with names inferred from
    <code>par_names</code> if this was supplied.</p></dd>
  If alg_deriv and/or alg_hess were supplied then these are
  returned as further attributes.

  To view an individual attribute called att_name use
  attr(x, "att_name") or attributes(x)$att_name.

    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Three adjustments to the independence loglikelihood described in
  Chandler and Bate (2007) are available.  The vertical adjustment is
  described in Section 6 and two horizontal adjustments are described
  in Sections 3.2 to 3.4.  See the descriptions of <code>type</code> and, for the
  horizontal adjustments, the descriptions of <code>C_cholesky</code> and
  <code>C_spectral</code>, in <strong>Value</strong>.</p>
<p>The adjustments involve first and second derivatives of the loglikelihood
  with respect to the model parameters.  These are estimated using
  <code><a href='https://rdrr.io/pkg/numDeriv/man/jacobian.html'>jacobian</a></code> and <code><a href='https://rdrr.io/r/stats/optim.html'>optimHess</a></code>
  unless <code>alg_deriv</code> and/or <code>alg_hess</code> are supplied.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Chandler, R. E. and Bate, S. (2007). Inference for clustered
  data using the independence loglikelihood. <em>Biometrika</em>,
  <strong>94</strong>(1), 167-183. <a href='http://dx.doi.org/10.1093/biomet/asm015'>http://dx.doi.org/10.1093/biomet/asm015</a></p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='summary.chandwich.html'>summary.chandwich</a></code> for maximum likelihood estimates
  and unadjusted and adjusted standard errors.</p>
<p><code><a href='plot.chandwich.html'>plot.chandwich</a></code> for plots of one-dimensional adjusted
  loglikelihoods.</p>
<p><code><a href='confint.chandwich.html'>confint.chandwich</a></code>, <code><a href='anova.chandwich.html'>anova.chandwich</a></code>,
  <code><a href='coef.chandwich.html'>coef.chandwich</a></code>, <code><a href='vcov.chandwich.html'>vcov.chandwich</a></code>
  and <code><a href='logLik.chandwich.html'>logLik.chandwich</a></code> for other <code>chandwich</code> methods.</p>
<p><code><a href='conf_intervals.html'>conf_intervals</a></code> for confidence intervals for
  individual parameters.</p>
<p><code><a href='conf_region.html'>conf_region</a></code> for a confidence region for
  a pair of parameters.</p>
<p><code><a href='compare_models.html'>compare_models</a></code> to compare nested models using an
  (adjusted) likelihood ratio test.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># ------------------------- Binomial model, rats data ----------------------</span>

<span class='co'># Contributions to the independence loglikelihood</span>
<span class='no'>binom_loglik</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>prob</span>, <span class='no'>data</span>) {
  <span class='kw'>if</span> (<span class='no'>prob</span> <span class='kw'>&lt;</span> <span class='fl'>0</span> <span class='kw'>||</span> <span class='no'>prob</span> <span class='kw'>&gt;</span> <span class='fl'>1</span>) {
    <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(-<span class='fl'>Inf</span>)
  }
  <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>dbinom</a></span>(<span class='no'>data</span>[, <span class='st'>"y"</span>], <span class='no'>data</span>[, <span class='st'>"n"</span>], <span class='no'>prob</span>, <span class='kw'>log</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>))
}
<span class='no'>rat_res</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='kw'>loglik</span> <span class='kw'>=</span> <span class='no'>binom_loglik</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>rats</span>, <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='st'>"p"</span>)

<span class='co'># Plot the loglikelihoods</span>
<span class='fu'><a href='https://rdrr.io/r/base/plot.html'>plot</a></span>(<span class='no'>rat_res</span>, <span class='kw'>type</span> <span class='kw'>=</span> <span class='fl'>1</span>:<span class='fl'>4</span>, <span class='kw'>legend_pos</span> <span class='kw'>=</span> <span class='st'>"bottom"</span>, <span class='kw'>lwd</span> <span class='kw'>=</span> <span class='fl'>2</span>, <span class='kw'>col</span> <span class='kw'>=</span> <span class='fl'>1</span>:<span class='fl'>4</span>)</div><div class='input'><span class='co'># MLE, SEs and adjusted SEs</span>
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>rat_res</span>)</div><div class='output co'>#&gt;      MLE       SE adj. SE
#&gt; p 0.1535 0.008645 0.01305</div><div class='input'>
<span class='co'># -------------------------- GEV model, owtemps data -----------------------</span>
<span class='co'># ------------ following Section 5.2 of Chandler and Bate (2007) -----------</span>

<span class='co'># Contributions to the independence loglikelihood</span>
<span class='no'>gev_loglik</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>pars</span>, <span class='no'>data</span>) {
  <span class='no'>o_pars</span> <span class='kw'>&lt;-</span> <span class='no'>pars</span>[<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>1</span>, <span class='fl'>3</span>, <span class='fl'>5</span>)] + <span class='no'>pars</span>[<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>2</span>, <span class='fl'>4</span>, <span class='fl'>6</span>)]
  <span class='no'>w_pars</span> <span class='kw'>&lt;-</span> <span class='no'>pars</span>[<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>1</span>, <span class='fl'>3</span>, <span class='fl'>5</span>)] - <span class='no'>pars</span>[<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fl'>2</span>, <span class='fl'>4</span>, <span class='fl'>6</span>)]
  <span class='kw'>if</span> (<span class='fu'><a href='https://rdrr.io/r/base/Logic.html'>isTRUE</a></span>(<span class='no'>o_pars</span>[<span class='fl'>2</span>] <span class='kw'>&lt;=</span> <span class='fl'>0</span> <span class='kw'>|</span> <span class='no'>w_pars</span>[<span class='fl'>2</span>] <span class='kw'>&lt;=</span> <span class='fl'>0</span>)) <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(-<span class='fl'>Inf</span>)
  <span class='no'>o_data</span> <span class='kw'>&lt;-</span> <span class='no'>data</span>[, <span class='st'>"Oxford"</span>]
  <span class='no'>w_data</span> <span class='kw'>&lt;-</span> <span class='no'>data</span>[, <span class='st'>"Worthing"</span>]
  <span class='no'>check</span> <span class='kw'>&lt;-</span> <span class='fl'>1</span> + <span class='no'>o_pars</span>[<span class='fl'>3</span>] * (<span class='no'>o_data</span> - <span class='no'>o_pars</span>[<span class='fl'>1</span>]) / <span class='no'>o_pars</span>[<span class='fl'>2</span>]
  <span class='kw'>if</span> (<span class='fu'><a href='https://rdrr.io/r/base/Logic.html'>isTRUE</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span>(<span class='no'>check</span> <span class='kw'>&lt;=</span> <span class='fl'>0</span>))) <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(-<span class='fl'>Inf</span>)
  <span class='no'>check</span> <span class='kw'>&lt;-</span> <span class='fl'>1</span> + <span class='no'>w_pars</span>[<span class='fl'>3</span>] * (<span class='no'>w_data</span> - <span class='no'>w_pars</span>[<span class='fl'>1</span>]) / <span class='no'>w_pars</span>[<span class='fl'>2</span>]
  <span class='kw'>if</span> (<span class='fu'><a href='https://rdrr.io/r/base/Logic.html'>isTRUE</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/any.html'>any</a></span>(<span class='no'>check</span> <span class='kw'>&lt;=</span> <span class='fl'>0</span>))) <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(-<span class='fl'>Inf</span>)
  <span class='no'>o_loglik</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='log_gev.html'>log_gev</a></span>(<span class='no'>o_data</span>, <span class='no'>o_pars</span>[<span class='fl'>1</span>], <span class='no'>o_pars</span>[<span class='fl'>2</span>], <span class='no'>o_pars</span>[<span class='fl'>3</span>])
  <span class='no'>w_loglik</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='log_gev.html'>log_gev</a></span>(<span class='no'>w_data</span>, <span class='no'>w_pars</span>[<span class='fl'>1</span>], <span class='no'>w_pars</span>[<span class='fl'>2</span>], <span class='no'>w_pars</span>[<span class='fl'>3</span>])
  <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='no'>o_loglik</span> + <span class='no'>w_loglik</span>)
}

<span class='co'># Initial estimates (method of moments for the Gumbel case)</span>
<span class='no'>sigma</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span>(<span class='fl'>6</span> * <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>var</a></span>(<span class='no'>owtemps</span>))) / <span class='no'>pi</span>)
<span class='no'>mu</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>colMeans</a></span>(<span class='no'>owtemps</span>) - <span class='fl'>0.57722</span> * <span class='no'>sigma</span>)
<span class='no'>init</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span>(<span class='no'>mu</span>), -<span class='fu'><a href='https://rdrr.io/r/base/diff.html'>diff</a></span>(<span class='no'>mu</span>) / <span class='fl'>2</span>, <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span>(<span class='no'>sigma</span>), -<span class='fu'><a href='https://rdrr.io/r/base/diff.html'>diff</a></span>(<span class='no'>sigma</span>) / <span class='fl'>2</span>, <span class='fl'>0</span>, <span class='fl'>0</span>)

<span class='co'># Loglikelihood adjustment for the full model</span>
<span class='no'>par_names</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"mu[0]"</span>, <span class='st'>"mu[1]"</span>, <span class='st'>"sigma[0]"</span>, <span class='st'>"sigma[1]"</span>, <span class='st'>"xi[0]"</span>, <span class='st'>"xi[1]"</span>)
<span class='no'>large</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>gev_loglik</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>owtemps</span>, <span class='kw'>init</span> <span class='kw'>=</span> <span class='no'>init</span>,
                       <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='no'>par_names</span>)
<span class='co'># Rows 1, 3 and 4 of Table 2 of Chandler and Bate (2007)</span>
<span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>large</span>))</div><div class='output co'>#&gt;           mu[0]  mu[1] sigma[0] sigma[1]    xi[0]    xi[1]
#&gt; MLE     81.1700 2.6680   3.7290   0.5312 -0.19890 -0.08835
#&gt; SE       0.3282 0.3282   0.2293   0.2293  0.04937  0.04937
#&gt; adj. SE  0.4036 0.2128   0.2426   0.1911  0.03943  0.03625</div><div class='input'>
<span class='co'># Loglikelihood adjustment of some smaller models: xi[1] = 0 etc</span>

<span class='co'># Starting from a larger model</span>
<span class='no'>medium</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='kw'>larger</span> <span class='kw'>=</span> <span class='no'>large</span>, <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='st'>"xi[1]"</span>)
<span class='no'>small</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='kw'>larger</span> <span class='kw'>=</span> <span class='no'>large</span>, <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"sigma[1]"</span>, <span class='st'>"xi[1]"</span>))
<span class='no'>small</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='kw'>larger</span> <span class='kw'>=</span> <span class='no'>medium</span>, <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"sigma[1]"</span>, <span class='st'>"xi[1]"</span>))

<span class='co'># Starting from scratch</span>
<span class='no'>medium</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>gev_loglik</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>owtemps</span>, <span class='kw'>init</span> <span class='kw'>=</span> <span class='no'>init</span>,
          <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='no'>par_names</span>, <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='st'>"xi[1]"</span>)
<span class='no'>small</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>gev_loglik</span>, <span class='kw'>data</span> <span class='kw'>=</span> <span class='no'>owtemps</span>, <span class='kw'>init</span> <span class='kw'>=</span> <span class='no'>init</span>,
         <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='no'>par_names</span>, <span class='kw'>fixed_pars</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"sigma[1]"</span>, <span class='st'>"xi[1]"</span>))

<span class='co'># --------- Misspecified Poisson model for negative binomial data ----------</span>

<span class='co'># ... following Section 5.1 of the "Object-Oriented Computation of Sandwich</span>
<span class='co'># Estimators" vignette of the sandwich package</span>
<span class='co'># https://cran.r-project.org/web/packages/sandwich/vignettes/sandwich-OOP.pdf</span>

<span class='co'># Simulate data</span>
<span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span>(<span class='fl'>123</span>)
<span class='no'>x</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='fl'>250</span>)
<span class='no'>y</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/NegBinomial.html'>rnbinom</a></span>(<span class='fl'>250</span>, <span class='kw'>mu</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span>(<span class='fl'>1</span> + <span class='no'>x</span>), <span class='kw'>size</span> <span class='kw'>=</span> <span class='fl'>1</span>)
<span class='co'># Fit misspecified Poisson model</span>
<span class='no'>fm_pois</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/glm.html'>glm</a></span>(<span class='no'>y</span> ~ <span class='no'>x</span> + <span class='fu'><a href='https://rdrr.io/r/base/AsIs.html'>I</a></span>(<span class='no'>x</span>^<span class='fl'>2</span>), <span class='kw'>family</span> <span class='kw'>=</span> <span class='no'>poisson</span>)
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>fm_pois</span>)$<span class='no'>coefficients</span></div><div class='output co'>#&gt;                Estimate Std. Error   z value      Pr(&gt;|z|)
#&gt; (Intercept)  1.06326821 0.04135723 25.709367 9.184267e-146
#&gt; x            0.99607219 0.05353446 18.606186  2.862861e-77
#&gt; I(x^2)      -0.04912373 0.02314608 -2.122335  3.380961e-02</div><div class='input'>
<span class='co'># Contributions to the independence loglikelihood</span>
<span class='no'>pois_glm_loglik</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>pars</span>, <span class='no'>y</span>, <span class='no'>x</span>) {
  <span class='no'>log_mu</span> <span class='kw'>&lt;-</span> <span class='no'>pars</span>[<span class='fl'>1</span>] + <span class='no'>pars</span>[<span class='fl'>2</span>] * <span class='no'>x</span> + <span class='no'>pars</span>[<span class='fl'>3</span>] * <span class='no'>x</span> ^ <span class='fl'>2</span>
  <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/Poisson.html'>dpois</a></span>(<span class='no'>y</span>, <span class='kw'>lambda</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span>(<span class='no'>log_mu</span>), <span class='kw'>log</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>))
}
<span class='no'>pars</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"alpha"</span>, <span class='st'>"beta"</span>, <span class='st'>"gamma"</span>)
<span class='no'>pois_quad</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>pois_glm_loglik</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='no'>y</span>, <span class='kw'>x</span> <span class='kw'>=</span> <span class='no'>x</span>, <span class='kw'>par_names</span> <span class='kw'>=</span> <span class='no'>pars</span>)
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>pois_quad</span>)</div><div class='output co'>#&gt;            MLE      SE adj. SE
#&gt; alpha  1.06300 0.04136 0.08378
#&gt; beta   0.99610 0.05354 0.10520
#&gt; gamma -0.04913 0.02315 0.03628</div><div class='input'>
<span class='co'># Providing algebraic derivatives and Hessian</span>
<span class='no'>pois_alg_deriv</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>pars</span>, <span class='no'>y</span>, <span class='no'>x</span>) {
  <span class='no'>mu</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span>(<span class='no'>pars</span>[<span class='fl'>1</span>] + <span class='no'>pars</span>[<span class='fl'>2</span>] * <span class='no'>x</span> + <span class='no'>pars</span>[<span class='fl'>3</span>] * <span class='no'>x</span> ^ <span class='fl'>2</span>)
  <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span>(<span class='no'>y</span> - <span class='no'>mu</span>, <span class='no'>x</span> * (<span class='no'>y</span> - <span class='no'>mu</span>), <span class='no'>x</span> ^<span class='fl'>2</span> * (<span class='no'>y</span> - <span class='no'>mu</span>)))
}
<span class='no'>pois_alg_hess</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>pars</span>, <span class='no'>y</span>, <span class='no'>x</span>) {
  <span class='no'>mu</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span>(<span class='no'>pars</span>[<span class='fl'>1</span>] + <span class='no'>pars</span>[<span class='fl'>2</span>] * <span class='no'>x</span> + <span class='no'>pars</span>[<span class='fl'>3</span>] * <span class='no'>x</span> ^ <span class='fl'>2</span>)
  <span class='no'>alg_hess</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span>(<span class='fl'>0</span>, <span class='fl'>3</span>, <span class='fl'>3</span>)
  <span class='no'>alg_hess</span>[<span class='fl'>1</span>, ] <span class='kw'>&lt;-</span> -<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> * <span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>2</span> * <span class='no'>mu</span>))
  <span class='no'>alg_hess</span>[<span class='fl'>2</span>, ] <span class='kw'>&lt;-</span> -<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> * <span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>2</span> * <span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>3</span> * <span class='no'>mu</span>))
  <span class='no'>alg_hess</span>[<span class='fl'>3</span>, ] <span class='kw'>&lt;-</span> -<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>2</span> * <span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>3</span> * <span class='no'>mu</span>), <span class='fu'><a href='https://rdrr.io/r/base/sum.html'>sum</a></span>(<span class='no'>x</span> ^ <span class='fl'>4</span> * <span class='no'>mu</span>))
  <span class='fu'><a href='https://rdrr.io/r/base/function.html'>return</a></span>(<span class='no'>alg_hess</span>)
}
<span class='no'>pois_quad</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>pois_glm_loglik</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='no'>y</span>, <span class='kw'>x</span> <span class='kw'>=</span> <span class='no'>x</span>, <span class='kw'>p</span> <span class='kw'>=</span> <span class='fl'>3</span>,
                           <span class='kw'>alg_deriv</span> <span class='kw'>=</span> <span class='no'>pois_alg_deriv</span>, <span class='kw'>alg_hess</span> <span class='kw'>=</span> <span class='no'>pois_alg_hess</span>)
<span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span>(<span class='no'>pois_quad</span>)</div><div class='output co'>#&gt;        MLE      SE adj. SE
#&gt; 1  1.06300 0.04136 0.08378
#&gt; 2  0.99610 0.05354 0.10520
#&gt; 3 -0.04913 0.02315 0.03628</div><div class='input'>
<span class='no'>got_sandwich</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ns-load.html'>requireNamespace</a></span>(<span class='st'>"sandwich"</span>, <span class='kw'>quietly</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)</div><div class='img'><img src='adjust_loglik-1.png' alt='' width='700' height='433' /></div><div class='input'><span class='kw'>if</span> (<span class='no'>got_sandwich</span>) {
  <span class='co'># Providing MLE, H and V</span>
  <span class='co'># H and V calculated using bread() and meat() from sandwich package</span>
  <span class='no'>n_obs</span> <span class='kw'>&lt;-</span> <span class='kw pkg'>stats</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/r/stats/nobs.html'>nobs</a></span>(<span class='no'>fm_pois</span>)
  <span class='no'>pois_quad</span> <span class='kw'>&lt;-</span> <span class='fu'>adjust_loglik</span>(<span class='no'>pois_glm_loglik</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='no'>y</span>, <span class='kw'>x</span> <span class='kw'>=</span> <span class='no'>x</span>, <span class='kw'>p</span> <span class='kw'>=</span> <span class='fl'>3</span>,
                             <span class='kw'>mle</span> <span class='kw'>=</span> <span class='no'>fm_pois</span>$<span class='no'>coefficients</span>,
                             <span class='kw'>H</span> <span class='kw'>=</span> -<span class='fu'><a href='https://rdrr.io/r/base/solve.html'>solve</a></span>(<span class='kw pkg'>sandwich</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sandwich/man/bread.html'>bread</a></span>(<span class='no'>fm_pois</span>) / <span class='no'>n_obs</span>),
                             <span class='kw'>V</span> <span class='kw'>=</span> <span class='kw pkg'>sandwich</span><span class='kw ns'>::</span><span class='fu'><a href='https://rdrr.io/pkg/sandwich/man/meat.html'>meat</a></span>(<span class='no'>fm_pois</span>) * <span class='no'>n_obs</span>)
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Paul J. Northrop, Richard E. Chandler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


